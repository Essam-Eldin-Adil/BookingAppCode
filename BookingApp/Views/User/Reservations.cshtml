@model List<UserReservationViewModel>
@{
    ViewData["Title"] = "حجوزاتي";
    //Layout = "~/Views/Shared/_EndUser_Profile_Layout.cshtml";
    Layout = "~/Views/Shared/_EndUser_Profile_Layout.cshtml";
}

@section css{
    <link rel="stylesheet" href="~/css/components/bs-rating.css" type="text/css" />
    <style>
        .rating-stars {
            font-size: 20px !important;
        }
    </style>
}
<div class="row">
    <div class="col-md-12">
        <h4>@ViewBag.Title</h4>
        @if (!Model.Any())
        {
            <div class="text-center">
                <h3 class="mb-2">@Resource.NoReservations</h3>
                <p>@Resource.YouCanWatchAndReserve</p>
                <a href="~/Search/Index" class="button button-circle button-small">@Resource.DiscoverNow</a>
            </div>
        }
        <div class="row">
            @foreach (var item in Model)
            {
                var rate = (item.CleaningRate + item.CrewRate + item.PropertyConditionRate) / 3;

                var unit = item.Unit;
                var image = Url.Content("~/images/noimg.jpg");
                if (unit.UnitImages.Count > 0)
                {
                    var uitImage = unit.UnitImages.OrderByDescending(c => c.IsPrimary).FirstOrDefault();
                    image = Url.Content("~/" + uitImage.File.FileContentMin);
                }
                <div class="real-estate-item portfolio-item col-12 col-md-6 col-lg-4 mb-5">
                    <div class="real-estate-item-image">
                        <div class="label badge badge-danger bg-color2" style="background-color:rgb(0 0 0 / 52%) !important">
                            @unit.Views <i class="icon-eye"></i>
                        </div>
                        
                        <a href="#">
                            <img src="@image" class="w-100" alt="Image 1">
                        </a>
                        <div class="real-estate-item-price" style="direction:rtl">
                            @unit.DayPrice @Resource.Currency<span>@Resource.PricePerNight</span>
                        </div>
                        <div class="real-estate-item-info clearfix" data-lightbox="gallery">
                            <a href="#" data-toggle="tooltip" title="@Resource.Rate">
                                <i class="icon-star3 text-warning"></i> @string.Format("{0:N2}", rate) (@item.RateCount) @Resource.Rate
                            </a>
                        </div>
                    </div>

                    <div class="real-estate-item-desc p-0">
                        <h3>
                            <a href="@Url.Action("Index","Unit",new {id=unit.Id,DateFrom=DateTime.Now,DateTo=DateTime.Now })">
                                @unit.Name
                            </a>
                        </h3>
                        <span><i class="icon-location"></i> @unit.Chalet.City.CityName, @unit.Chalet.Neighborhood</span>

                        @if (item.Status == (int)Enums.Status.Cancled)
                        {
                            <span class="badge badge-danger">
                                @Resource.Cancled
                            </span>
                        }
                        else if (item.Status == (int)Enums.Status.New)
                        {
                            <span class="badge badge-warning">
                                @Resource.ConfirmPending
                            </span>
                        }
                        else if (item.Status == (int)Enums.Status.Confirmed)
                        {
                            <span class="badge badge-success">
                                @Resource.Confirmed
                            </span>
                        }<br />
                        <a href="~/Unit/ReservationDetails/@item.Id" class="btn btn-success btn-sm mt-1"><i class="icon-calendar-check"></i> @Resource.ReservationDetails</a>
                        <button onclick="rates('@item.UserRate.Id', '@item.UserRate.Crew', '@item.UserRate.Cleaning', '@item.UserRate.PropertyCondition', '@item.UserRate.Comment', '@item.UnitId')" class="btn btn-warning btn-sm mt-1" data-target="#rateModal" data-toggle="modal"><i class="icon-star3"></i> @Resource.AddRateAndComments</button>
                        <button id="setMap" onclick="setMap('@item.Unit.Chalet.Latitude', '@item.Unit.Chalet.Longitude', '@item.Unit.Chalet.Location')" class="btn btn-outline-primary btn-sm mt-1" data-target="#mapModal" data-toggle="modal"><i class="icon-map-marked"></i> @Resource.Map</button>
                        @if (item.Status == (int)Enums.Status.New)
                        {
                                <button onclick="$('#ReservationId').val('@item.Id')" data-target="#cancelReservationModal" data-toggle="modal" class="btn btn-danger btn-sm mt-1"><i class="icon-remove"></i> @Resource.CancelReservation</button>
                        }
                    </div>
                </div>

            }
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="rateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-body">
            <form method="post" action="rate" class="modal-content was-validated">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="RateId" />
                    <input type="hidden" name="UnitId" id="Unit_Id" />
                    <input type="hidden" name="UserId" value="@SessionClass.GetUser(HttpContextAccessor.HttpContext).Id" />
                    <div class="form-group">
                        <label>@Resource.PropertyCondition</label>
                        <input name="PropertyCondition" id="PropertyCondition" type="number" class="rating" min="1" max="5" data-size="sm">
                    </div>
                    <div class="form-group">
                        <label>@Resource.Crew</label>
                        <input name="Crew" id="Crew1" type="number" class="rating" min="1" max="5" data-size="sm">
                    </div>
                    <div class="form-group">
                        <label>@Resource.Cleaning</label>
                        <input name="Cleaning" id="Cleaning" type="number" class="rating" min="1" max="5" data-size="sm">
                    </div>
                    <textarea class="form-control" id="Comment" required="" name="Comment"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">@Resource.Close</button>
                    <button type="submit" class="btn btn-primary">@Resource.SaveChanges</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="cancelReservationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-body">
            <form action="CancelReservation" method="post" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Resource.CancelReservation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <input type="hidden" name="ReservationId" id="ReservationId" />
                <input type="hidden" name="CancelResoun" value="@Resource.CanceledByUser" id="ReservationId" />
                <div class="modal-body">
                    <p>@Resource.DoYouWantCancelReservation</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">@Resource.Close</button>
                    <button type="submit" class="btn btn-primary">@Resource.SaveChanges</button>
                </div>
            </form>
        </div>
    </div>
</div>



<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-body">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationText"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <input type="hidden" id="longitude" />
                <input type="hidden" id="latitude" />
                <div class="modal-body min-vh-40" id="google-map">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">@Resource.Close</button>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts
{
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMvk54X0cJtOPiSu60rk-OdX8alzz7Htk&callback=initMap"
            type="text/javascript"></script>
    <script src="~/js/components/star-rating.js"></script>
    <script>
        function setMap(lat, long, text) {
            $("#locationText").html(text);
            $("#longitude").val(long);
            $("#latitude").val(lat);
            google.maps.event.trigger(map, 'resize');
        }
        function rates(id, crew, cleaning, condetion, comment, unitId) {
            $("#RateId").val(id);
            $("#PropertyCondition").val(condetion);
            $("#Cleaning").val(cleaning);
            $("#Crew1").val(crew);
            $("#Comment").val(comment);
            $("#Unit_Id").val(unitId);
            $(".rating").rating();
        }
        $(function () {
            $('.datepicker').datepicker({
                autoclose: true,
                startDate: "today",
                todayHighlight: true,
                format: "mm/dd/yyyy",
            });
        });
        $("#reservation").addClass("active");




        let map, infoWindow;


        function initMap() {
                image = 'http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png';

            var option = {
                center: { lat: 0, lng: 0 },
                zoom: 12,
                mapTypeId: "satellite",
                panControl: true,
                panControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                zoomControl: true,
                zoomControlOptions: {
                    style: google.maps.ZoomControlStyle.LARGE,
                    position: google.maps.ControlPosition.TOP_left
                }
            };
            map = new google.maps.Map(document.getElementById("google-map"), option);

            marker = new google.maps.Marker({
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                position: { lat: 0, lng: 0 }
            });

            var onChangeHandler = function () {
                DisplayPoint(map);
            };
            document.getElementById('setMap').addEventListener('click', onChangeHandler);
            function DisplayPoint(map) {
                var lat = $("#latitude").val();
                var lng = $("#longitude").val();
                var latLng = new google.maps.LatLng(lat, lng);
                marker.setPosition(latLng);
                map.panTo(latLng);

            }
           
        }


    </script>
}


